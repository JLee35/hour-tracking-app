<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> 

    <!-- Start external style references -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> 
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.8.7/chosen.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/css/bootstrap-datepicker.css" />
    <!-- End external style references -->

    <!-- Start external script references -->
    <script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>    
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.8.7/chosen.jquery.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/js/bootstrap-datepicker.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@2.3.2/dist/signature_pad.min.js"></script>
    <script src="https://unpkg.com/ionicons@4.5.5/dist/ionicons.js"></script>
    <!-- End external script references -->  
</head>

<!-- Start internal style references -->
<style>    
  <?!= include('css/scoutLakeCSS'); ?> 
</style>
<!-- End internal style references -->

<body>
  <!-- Start main container -->
  <div class="container paddedPage">

    <!-- Start Sign out button -->
    <div class="text-right">
        <button id="topSignOut" class="btn btn-primary">
            Sign Out
        </button>
    </div>
    <!-- End Sign out button -->
    
    <!-- Progress Bar -->
    <?!= include('html/progressBar'); ?>

    <!-- Introduction Page -->
    <?!= include('html/introductionPage'); ?>

    <!-- Employee Info Page -->
    <?!= include('html/employeeInfoPage'); ?>

    <!-- General Info Page -->
    <?!= include('html/generalInfoPage'); ?>

    <!-- Specific Info Page -->
    <?!= include('html/specificInfoPage'); ?>

    <!-- Review, Sign, Submit Page -->
    <?!= include('html/reviewSignSubmitPage'); ?>

    <!-- Add Another Employee Modal -->
    <?!= include('html/addAnotherEmployeeModal'); ?>

    <!-- Please Wait modal -->
    <?!= include('html/pleaseWaitModal'); ?>
    
  </div>
  <!-- End main container -->

  <script>
      
    var playerName = <?=data.playerId?>; // holds player name for top bar
    var playerId = "";

    var workOrders;
    var phaseCodes;

    // from https://developers.google.com/apps-script/guides/html/reference/url#methods
    google.script.url.getLocation(function(location) {
      playerId = location.parameter['id'];
    });

    // This said to use getElementById instead of jQuery: https://stackoverflow.com/questions/5808162/getcontext-is-not-a-function
    // That fixed a "t.getcontext is not a function" error
    // signature_pad from: https://github.com/szimek/signature_pad

    // Note: Signature pad must stay in main HTML.
    var element = document.getElementById("testMedia");
    style = window.getComputedStyle(element);

    $("#signatureDiv").html("");
    $("#signatureDiv").html('<canvas id="signature" width="' + style.getPropertyValue("width") + '" height="200" class="signature-box"></canvas>')
    var canvas = document.getElementById("signature");
    var signaturePad = new SignaturePad(canvas);

    $("#toDelete").html('');

  function initializeFromSheet() {
    google.script.run.withSuccessHandler(initializeSuccess).withFailureHandler(initializeFailure).loadFromSpreadsheet();
  }

  // Callback function for client-side loadFromSpreadsheet function.
  function initializeFailure(error) {
    console.log(error);
  }

  // Callback function for client-side loadFromSpreadsheet function.
  function initializeSuccess(serverSideReturn) {
    workOrders = serverSideReturn[0];
    phaseCodes = serverSideReturn[1];

    for (var i = 0; i < workOrders.length; i++) {
      $("#jobNumber").append('<option value="' + workOrders[i][0] + "  " + "(" + workOrders[i][1] + ")" + '">' + workOrders[i][0] + "  " + "(" + workOrders[i][1] + ")" + "</option>");
    }
    
    for (var i = 0; i < phaseCodes.length; i++) {
      if(phaseCodes[i][1] != "")
        $("#phaseCodeInput").append('<option value="' + phaseCodes[i][0] + "  " + "(" + phaseCodes[i][1] + ")" + '">' + phaseCodes[i][0] + "  " + "(" + phaseCodes[i][1] + ")" + "</option>");
    }

    $("#jobNumber").chosen({width: "100%"});

    // Auto width here: https://stackoverflow.com/questions/10303120/jquery-chosen-plugin-not-styling-correctly-very-small
    var opts = {};
    if (!$("#phaseCodeInput").is(':visible')) {
      opts["width"] = '100%';
    }
    $("#phaseCodeInput").chosen(opts);
  }

  initializeFromSheet();
 
/****************************************************************

   FUNCTION:   signOutBtn onclick

   ARGUMENTS:  none

   RETURNS:    none

   NOTES:      Handles onclick of the sign-out button.
               Opens in same page.
****************************************************************/
    
    $("#signOutBtn").click(function(){

      $("#pleaseWaitModal").modal('show');

      $("#progressBar1").removeClass("bg-success");
      $("#progressBar1").addClass("bg-warning");
      $("#progressBar2").removeClass("bg-success");
      $("#progressBar2").addClass("bg-danger");
      $("#progressBar3").removeClass("bg-success");
      $("#progressBar3").addClass("bg-danger");
      $("#progressBar4").removeClass("bg-warning");
      $("#progressBar4").addClass("bg-danger");

      $('#addAnotherEmployeeModal').modal('hide');

      // add info for this employee to employee array
      // TODO total hours and labor hours 
      var pngImage = signaturePad.toDataURL("image/png");
      var date2 = new Date();
      var swimlaneinfo = [];
      var mondayitems = $("#mondayDetailsLane").find("div.swim-lane-item-content");
      var mondaylist = [];

      mondayitems.each(function (index, element) {
            var desc = $(element).find('p.full-phase-code-description')[0].textContent;
            var hours = $(element).find('p.swim-lane-item-hours')[0].textContent;

            mondaylist.push([desc,hours]);
        });

      swimlaneinfo.push(mondaylist);

      var tuesdayitems = $("#tuesdayDetailsLane").find("div.swim-lane-item-content");
      var tuesdaylist = [];

      tuesdayitems.each(function (index, element) {
            var desc = $(element).find('p.full-phase-code-description')[0].textContent;
            var hours = $(element).find('p.swim-lane-item-hours')[0].textContent;

            tuesdaylist.push([desc,hours]);
        });

      swimlaneinfo.push(tuesdaylist);

      var wednesdayitems = $("#wednesdayDetailsLane").find("div.swim-lane-item-content");
      var wednesdaylist = [];

      wednesdayitems.each(function (index, element) {
            var desc = $(element).find('p.full-phase-code-description')[0].textContent;
            var hours = $(element).find('p.swim-lane-item-hours')[0].textContent;

            wednesdaylist.push([desc,hours]);
        });

      swimlaneinfo.push(wednesdaylist);

      var thursdayitems = $("#thursdayDetailsLane").find("div.swim-lane-item-content");
      var thursdaylist = [];

      thursdayitems.each(function (index, element) {
            var desc = $(element).find('p.full-phase-code-description')[0].textContent;
            var hours = $(element).find('p.swim-lane-item-hours')[0].textContent;

            thursdaylist.push([desc,hours]);
        });

      swimlaneinfo.push(thursdaylist);

      var fridayitems = $("#fridayDetailsLane").find("div.swim-lane-item-content");
      var fridaylist = [];

      fridayitems.each(function (index, element) {
            var desc = $(element).find('p.full-phase-code-description')[0].textContent;
            var hours = $(element).find('p.swim-lane-item-hours')[0].textContent;

            fridaylist.push([desc,hours]);
        });

      swimlaneinfo.push(fridaylist);

      var saturdayitems = $("#saturdayDetailsLane").find("div.swim-lane-item-content");
      var saturdaylist = [];

      saturdayitems.each(function (index, element) {
            var desc = $(element).find('p.full-phase-code-description')[0].textContent;
            var hours = $(element).find('p.swim-lane-item-hours')[0].textContent;

            saturdaylist.push([desc,hours]);
        });

      swimlaneinfo.push(saturdaylist);

      var sundayitems = $("#sundayDetailsLane").find("div.swim-lane-item-content");
      var sundaylist = [];

      sundayitems.each(function (index, element) {
            var desc = $(element).find('p.full-phase-code-description')[0].textContent;
            var hours = $(element).find('p.swim-lane-item-hours')[0].textContent;

            sundaylist.push([desc,hours]);
        });

      swimlaneinfo.push(sundaylist);

      allEmployeeInfo.push([$("#employeeName").val(), $("#jobNumber").val(), $("#weekEnding").val(), generalHourInfo, pngImage.substr(22), date2.toLocaleString(), swimlaneinfo]);

      if(allEmployeeInfo.length > 0) // meaning info for at least one employee has been completed
      {
        // Send all info to the Spreadsheet
        google.script.run.withSuccessHandler(submitSuccess).withFailureHandler(submitFailure).submitEmployeeInfo(sessionStorage.getItem("inputEmail"), allEmployeeInfo);
      }
      else
      {
        currentPage = "supervisorReview";  
        var baseURL = <?=ScriptApp.getService().getUrl()?>;
        window.open(baseURL, "_top");
      }
    });

$("#topSignOut").click(function(){
  $("#signOutBtn").click();
});

// Callback function for client-side insertEmployeeInfo function.
function submitFailure(error) {
  console.log(error);
  currentPage = "supervisorReview";  
  var baseURL = <?=ScriptApp.getService().getUrl()?>;
  window.open(baseURL, "_top");
}

// Callback function for client-side insertEmployeeInfo function.
function submitSuccess()
{
  currentPage = "supervisorReview";  
  var baseURL = <?=ScriptApp.getService().getUrl()?>;
  window.open(baseURL, "_top");
}

/****************************************************************

   FUNCTION:   specificInfoBackBtn onclick

   ARGUMENTS:  none

   RETURNS:    none

   NOTES:      Returns to general info page
               
****************************************************************/

$("#specificInfoBackBtn").click(function() {

  $("#specificInfoPage").css('display', 'none');
  $("#generalInfoPage").css('display', 'block');

  $("#progressBar3").removeClass("progress-highlight");
  $("#progressBar2").addClass("progress-highlight");
  currentPage = "generalInfoPage";       

  return;
});

  /****************************************************************

   FUNCTION:   supervisorAcceptHoursBtn onclick

   ARGUMENTS:  none

   RETURNS:    none

   NOTES:      Submits info to spreadsheet, then either logs out or moves to next employee
               
****************************************************************/

$("#supervisorAcceptHoursBtn").click(function() {
      $('#addAnotherEmployeeModal').modal('show');

    });

  /****************************************************************

   FUNCTION:   supervisorAcceptBackBtn onclick

   ARGUMENTS:  none

   RETURNS:    none

   NOTES:      Returns to specific info page
               
****************************************************************/

$("#supervisorAcceptBackBtn").click(function() {
    $("#supervisorReviewPage").css('display', 'none');
    $("#specificInfoPage").css('display', 'block');

    $("#progressBar4").removeClass("progress-highlight");
    $("#progressBar3").addClass("progress-highlight");

    currentPage = "specificInfoPage";    

    });

    
    var currentPage = "introductionPage"; // The currently displayed page
    var previousPage = "";

    // will be used to hold all of the info for the employees for this supervisor
    var allEmployeeInfo = [];
    var generalHourInfo = [[["-"],["-"],["-"],["-"]],[["-"],["-"],["-"],["-"]],[["-"],["-"],["-"],["-"]],[["-"],["-"],["-"],["-"]],[["-"],["-"],["-"],["-"]],[["-"],["-"],["-"],["-"]],[["-"],["-"],["-"],["-"]]];

    //Declare Initialize global variables

    //INITIALLY MAKE ALL PAGES EXCEPT the introduction page invisible
    $("#generalInfoPage").css("display", "none");
    $("#specificInfoPage").css('display', 'none');
    $("#supervisorReviewPage").css("display", "none");
    $("#employeeInfoPage").css("display", "none");

  </script>

    <?!= include('js/introductionJS'); ?>
    <?!= include('js/employeeInfoJS'); ?>
    <?!= include('js/generalInfoJS'); ?>
    <?!= include('js/specificInfoJS'); ?>
    <?!= include('js/reviewSignSubmitJS'); ?>
  </body>
</html>

